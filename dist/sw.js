const CACHE_NAME="ceritakita-v6",API_BASE_URL="https://story-api.dicoding.dev/v1",STATIC_ASSETS=["/","/index.html","/offline.html","/styles/styles.css","/manifest.json","/images/logo.png","/images/favicon.png","/app.bundle.js"];async function syncPendingStories(){const e=await openPendingDB(),t=e.transaction("pendingStories","readonly"),n=t.objectStore("pendingStories"),o=await new Promise(((e,t)=>{const o=n.getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)}));await new Promise((e=>t.oncomplete=e));let i=0;for(const t of o)try{if(!t?.description||!t?.token){console.warn("⛔ Data story tidak lengkap, dilewati:",t);continue}const n=new FormData;n.append("description",t.description),t.photoFile instanceof Blob&&n.append("photo",t.photoFile,"offline-photo.jpg"),void 0!==t.lat&&void 0!==t.lon&&(n.append("lat",t.lat),n.append("lon",t.lon));const o=await fetch(`${API_BASE_URL}/stories`,{method:"POST",headers:{Authorization:`Bearer ${t.token}`},body:n});if(o.ok){console.log("✅ Cerita offline berhasil di-sync:",t.description),i++;const n=e.transaction("pendingStories","readwrite");n.objectStore("pendingStories").openCursor().onsuccess=e=>{const n=e.target.result;if(n){const e=n.value;t.clientId&&e.clientId&&e.clientId===t.clientId&&n.delete(),n.continue()}},await new Promise((e=>n.oncomplete=e))}else{const e=await o.text();console.warn("⚠️ Gagal sync story (HTTP):",o.status,e)}}catch(e){console.error("⚠️ Gagal sync story offline:",e)}i>0&&self.registration.showNotification("Cerita Kita",{body:`${i} cerita kamu berhasil diunggah ke server 🎉`,icon:"/images/logo.png",badge:"/images/favicon.png"}),e.close()}function openPendingDB(){return new Promise(((e,t)=>{const n=indexedDB.open("story-app-db",2);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("pendingStories")||t.createObjectStore("pendingStories",{keyPath:"id",autoIncrement:!0})},n.onsuccess=t=>e(t.target.result),n.onerror=e=>t(e.target.error)}))}self.addEventListener("install",(e=>{e.waitUntil(caches.open(CACHE_NAME).then((e=>e.addAll(STATIC_ASSETS)))),self.skipWaiting()})),self.addEventListener("activate",(e=>{e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return caches.delete(e)})))))),self.clients.claim(),console.log("✅ SW aktif, tapi tidak memaksa reload")})),self.addEventListener("fetch",(e=>{const{request:t}=e;t.url.startsWith(API_BASE_URL)?e.respondWith(fetch(t).then((e=>{if(!e||200!==e.status)return e;const n=e.clone();return caches.open(CACHE_NAME).then((e=>e.put(t,n))),e})).catch((()=>new Response(JSON.stringify({error:!0,message:"Offline mode – API unavailable."}),{headers:{"Content-Type":"application/json"}})))):e.respondWith(caches.match(t).then((e=>e||fetch(t).then((e=>{const n=e.clone();return caches.open(CACHE_NAME).then((e=>e.put(t,n))),e})).catch((()=>"navigate"===t.mode?caches.match("/offline.html"):new Response("",{status:408,statusText:"Offline"}))))))})),self.addEventListener("push",(e=>{let t={};try{t=e.data?e.data.json():{}}catch{t={}}const n=t.title||"Cerita Kita",o={body:t.body||"Ada cerita baru yang menarik untukmu!",icon:"/images/logo.png",badge:"/images/favicon.png",data:{url:t.url||"/"}};e.waitUntil(self.registration.showNotification(n,o))})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=e.notification?.data?.url||"/";e.waitUntil(clients.openWindow(t))})),self.addEventListener("sync",(e=>{"sync-stories"===e.tag&&e.waitUntil(syncPendingStories())})),self.addEventListener("message",(e=>{"manual-sync"===e.data?.action&&(console.log("🔄 Manual sync dari client dijalankan..."),e.waitUntil(syncPendingStories()))}));